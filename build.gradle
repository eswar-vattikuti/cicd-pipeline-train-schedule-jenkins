plugins {
  id "com.github.node-gradle.node" version "7.0.2"
}

// Remove nodejs before every build - test
task cleanNode(type: Delete) {
    delete 'build/nodejs'
}

node {
    download = true
    version = "9.11.1"
    npmVersion = "5.6.0"
    workDir = file("${project.buildDir}/nodejs")
    npmWorkDir = file("${project.buildDir}/npm")
}

// Declare a simple task to build
task build

// Update the zip task to use new properties
task zip(type: Zip) {
    from('.') {
        include "*"
        include "bin/**"
        include "data/**"
        include "node_modules/**"
        include "public/**"
        include "routes/**"
        include "views/**"
    }
    // Use destinationDirectory for Gradle 8.7 compatibility
    destinationDirectory = file("$buildDir/dist")
    archiveBaseName.set("trainSchedule")
}


// Declare task dependencies using task paths to ensure correct task execution order
nodeSetup.dependsOn cleanNode
build.dependsOn 'zip'
zip.dependsOn 'npm_build'
npm_build.dependsOn 'npm_test'
npm_test.dependsOn 'npmInstall'
npm_build.dependsOn 'npmInstall'

